name: Build Installers

on:
  release:
    types: [created]

permissions:
  contents: write

jobs:
  build-windows:
    name: Build Windows (.msi)
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set app version from release tag
        env:
          RELEASE_TAG: ${{ github.event.release.tag_name }}
        run: |
          node -e "const fs=require('fs'); const p='src-tauri/tauri.conf.json'; const cfg=JSON.parse(fs.readFileSync(p,'utf8')); const v=(process.env.RELEASE_TAG||'').replace(/^v/,''); cfg.version=v; fs.writeFileSync(p, JSON.stringify(cfg,null,2)); console.log('tauri.conf.json version set to', v);"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: x86_64-pc-windows-msvc

      - name: Install dependencies
        run: |
          rustup target add x86_64-pc-windows-msvc

      - name: Install Tauri CLI
        run: cargo install tauri-cli

      - name: Build Tauri app
        working-directory: ./src-tauri
        run: cargo tauri build --target x86_64-pc-windows-msvc

      - name: Upload Windows installer to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            src-tauri/target/release/bundle/msi/*.msi

  build-macos:
    name: Build macOS (.dmg)
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set app version from release tag
        env:
          RELEASE_TAG: ${{ github.event.release.tag_name }}
        run: |
          node -e "const fs=require('fs'); const p='src-tauri/tauri.conf.json'; const cfg=JSON.parse(fs.readFileSync(p,'utf8')); const v=(process.env.RELEASE_TAG||'').replace(/^v/,''); cfg.version=v; fs.writeFileSync(p, JSON.stringify(cfg,null,2)); console.log('tauri.conf.json version set to', v);"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: aarch64-apple-darwin

      - name: Install Tauri CLI
        run: cargo install tauri-cli

      - name: Build Tauri app
        working-directory: ./src-tauri
        run: cargo tauri build --target aarch64-apple-darwin

      - name: Upload macOS installer to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            src-tauri/target/release/bundle/dmg/*.dmg

  build-linux:
    name: Build Linux (.deb, .AppImage)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set app version from release tag
        env:
          RELEASE_TAG: ${{ github.event.release.tag_name }}
        run: |
          node -e "const fs=require('fs'); const p='src-tauri/tauri.conf.json'; const cfg=JSON.parse(fs.readFileSync(p,'utf8')); const v=(process.env.RELEASE_TAG||'').replace(/^v/,''); cfg.version=v; fs.writeFileSync(p, JSON.stringify(cfg,null,2)); console.log('tauri.conf.json version set to', v);"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: x86_64-unknown-linux-gnu

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.0-dev libappindicator3-dev librsvg2-dev pkg-config build-essential libayatana-appindicator-dev

      - name: Install Tauri CLI
        run: cargo install tauri-cli

      - name: Build Tauri app (DEB)
        working-directory: ./src-tauri
        run: cargo tauri build --target x86_64-unknown-linux-gnu --bundler deb

      - name: Build Tauri app (AppImage)
        working-directory: ./src-tauri
        run: cargo tauri build --target x86_64-unknown-linux-gnu --bundler appimage

      - name: Upload Linux installers to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/appimage/*.AppImage
            MACOS_INSTALL.md
